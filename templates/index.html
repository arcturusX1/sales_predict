<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sales Prediction Pipeline</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #666;
        font-size: 14px;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 1200px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #667eea;
      }

      .status-item {
        padding: 12px;
        margin: 8px 0;
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        border-radius: 4px;
      }

      .status-label {
        color: #666;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-value {
        color: #333;
        font-size: 16px;
        margin-top: 5px;
        font-weight: 500;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        color: #333;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .alert {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      th {
        background: #f8f9fa;
        color: #333;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .metric-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin: 10px 0;
      }

      .metric-value {
        font-size: 28px;
        font-weight: bold;
        margin: 10px 0;
      }

      .metric-label {
        font-size: 12px;
        opacity: 0.9;
        text-transform: uppercase;
      }

      .chart-container {
        position: relative;
        width: 100%;
        height: 400px;
        margin: 20px 0;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 1200px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }
      }

      .tabs {
        display: flex;
        border-bottom: 2px solid #ddd;
        margin-bottom: 20px;
      }

      .tab-button {
        background: none;
        border: none;
        padding: 12px 20px;
        color: #666;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.3s;
      }

      .tab-button.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .spinner {
        text-align: center;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸŽ¯ Sales Prediction Pipeline</h1>
        <p class="subtitle">
          AI-powered retail sales forecasting and model management
        </p>
      </header>

      <!-- Status Dashboard -->
      <div class="dashboard">
        <div class="card">
          <h2>ðŸ“Š System Status</h2>
          <div id="statusContent">
            <div class="spinner">
              <div class="loading"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>ðŸ“ˆ Data Overview</h2>
          <div id="dataContent">
            <div class="spinner">
              <div class="loading"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Training Section -->
      <div class="card">
        <h2>ðŸ¤– Train New Model</h2>
        <div id="trainingAlert"></div>
        <div class="form-group">
          <label for="modelType">Model Type</label>
          <select id="modelType">
            <option value="xgboost">XGBoost</option>
            <option value="catboost">CatBoost</option>
          </select>
        </div>
        <div class="form-group">
          <label for="trainingPeriod">Training Period</label>
          <select id="trainingPeriod">
            <option value="">Full Dataset (Recommended)</option>
            <option value="3months">Last 3 Months</option>
            <option value="jan_2025">January 2025</option>
          </select>
        </div>
        <button onclick="trainModel()" id="trainBtn">Start Training</button>
      </div>

      <!-- Tabs Section -->
      <div class="card" style="margin-top: 20px">
        <div class="tabs">
          <button class="tab-button active" onclick="switchTab('models')">
            ðŸ“¦ Models
          </button>
          <button class="tab-button" onclick="switchTab('predictions')">
            ðŸ”® Predictions
          </button>
          <button class="tab-button" onclick="switchTab('data')">
            ðŸ“‹ Data
          </button>
        </div>

        <!-- Models Tab -->
        <div id="models-tab" class="tab-content active">
          <h2>Available Models</h2>
          <div id="modelsContent">
            <div class="spinner">
              <div class="loading"></div>
            </div>
          </div>
        </div>

        <!-- Predictions Tab -->
        <div id="predictions-tab" class="tab-content">
          <h2>Generate Predictions</h2>
          <div id="predictionsAlert"></div>
          <div class="form-group">
            <label for="modelSelect">Select Model</label>
            <select id="modelSelect"></select>
          </div>
          <div class="form-group">
            <label for="outletSelect">Outlet (Optional)</label>
            <select id="outletSelect">
              <option value="">All Outlets</option>
            </select>
          </div>
          <div class="form-group">
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" />
          </div>
          <div class="form-group">
            <label for="endDate">End Date</label>
            <input type="date" id="endDate" />
          </div>
          <button onclick="makePredictions()" id="predictBtn">
            Generate Predictions
          </button>
          <div id="predictionResults" style="margin-top: 20px"></div>
        </div>

        <!-- Data Tab -->
        <div id="data-tab" class="tab-content">
          <h2>Historical Data</h2>
          <div class="form-group">
            <label for="dataOutlet">Outlet</label>
            <select id="dataOutlet">
              <option value="">All Outlets</option>
            </select>
          </div>
          <div class="button-group">
            <input type="date" id="dataStartDate" />
            <input type="date" id="dataEndDate" />
          </div>
          <button onclick="loadData()" style="width: 100%; margin-top: 10px">
            Load Data
          </button>
          <div id="dataResults" style="margin-top: 20px"></div>
        </div>
      </div>
    </div>

    <script>
      // API Base URL
      const API_URL = "http://localhost:8000/api";

      // Chart instances storage
      let monthlySalesChart = null;
      let dailyTrendChart = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadStatus();
        loadDataSummary();
        loadModels();
        loadOutlets();
        setDefaultDates();
      });

      function setDefaultDates() {
        const today = new Date();
        const start = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

        document.getElementById("startDate").valueAsDate = new Date();
        document.getElementById("endDate").valueAsDate = new Date(
          today.getTime() + 30 * 24 * 60 * 60 * 1000,
        );
        document.getElementById("dataStartDate").valueAsDate = start;
        document.getElementById("dataEndDate").valueAsDate = today;
      }

      async function loadStatus() {
        try {
          const response = await fetch(API_URL + "/status");
          const data = await response.json();

          let html = "";
          if (data.models && data.models.length > 0) {
            html += `<div class="metric-box">
                        <div class="metric-label">Models Trained</div>
                        <div class="metric-value">${data.models.length}</div>
                    </div>`;
          }

          if (data.data_range) {
            const start = new Date(data.data_range.start).toLocaleDateString();
            const end = new Date(data.data_range.end).toLocaleDateString();
            html += `<div class="status-item">
                        <div class="status-label">Data Range</div>
                        <div class="status-value">${start} to ${end}</div>
                    </div>`;
            html += `<div class="status-item">
                        <div class="status-label">Total Records</div>
                        <div class="status-value">${data.data_range.total_records.toLocaleString()}</div>
                    </div>`;
          }

          document.getElementById("statusContent").innerHTML =
            html || "<p>No status available</p>";
        } catch (error) {
          console.error("Error loading status:", error);
          document.getElementById("statusContent").innerHTML =
            '<div class="alert alert-error">Error loading status</div>';
        }
      }

      async function loadDataSummary() {
        try {
          const response = await fetch(API_URL + "/data/summary");
          const data = await response.json();

          let html = `
                    <div class="metric-box">
                        <div class="metric-label">Outlets</div>
                        <div class="metric-value">${data.outlets}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Avg Daily Sales</div>
                        <div class="status-value">$${Math.round(data.daily_stats.average_sales).toLocaleString()}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Max Daily Sales</div>
                        <div class="status-value">$${Math.round(data.daily_stats.max_sales).toLocaleString()}</div>
                    </div>
                `;

          document.getElementById("dataContent").innerHTML = html;
        } catch (error) {
          console.error("Error loading data summary:", error);
          document.getElementById("dataContent").innerHTML =
            '<div class="alert alert-error">Error loading data</div>';
        }
      }

      async function loadModels() {
        try {
          const response = await fetch(API_URL + "/models");
          const data = await response.json();

          let html =
            "<table><thead><tr><th>Model</th><th>Type</th><th>MAE</th><th>RMSE</th><th>RÂ²</th><th>Action</th></tr></thead><tbody>";

          const models = data.models || {};
          const modelSelect = document.getElementById("modelSelect");
          modelSelect.innerHTML = "";

          for (const [name, info] of Object.entries(models)) {
            const metrics = info.metrics || {};
            html += `<tr>
                        <td>${name}</td>
                        <td>${info.model_type || "Unknown"}</td>
                        <td>${metrics.mae ? "$" + Math.round(metrics.mae).toLocaleString() : "N/A"}</td>
                        <td>${metrics.rmse ? "$" + Math.round(metrics.rmse).toLocaleString() : "N/A"}</td>
                        <td>${metrics.r2 ? metrics.r2.toFixed(4) : "N/A"}</td>
                        <td><button onclick="predictWithModel('${name}')" style="padding: 6px 12px; font-size: 12px;">Use</button></td>
                    </tr>`;

            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            modelSelect.appendChild(option);
          }

          html += "</tbody></table>";
          if (Object.keys(models).length === 0) {
            html = "<p>No models trained yet. Train one to get started!</p>";
          }

          document.getElementById("modelsContent").innerHTML = html;
        } catch (error) {
          console.error("Error loading models:", error);
          document.getElementById("modelsContent").innerHTML =
            '<div class="alert alert-error">Error loading models</div>';
        }
      }

      async function loadOutlets() {
        try {
          const response = await fetch(API_URL + "/data/summary");
          const data = await response.json();

          const outletSelect = document.getElementById("outletSelect");
          const dataOutlet = document.getElementById("dataOutlet");

          data.outlets_list.forEach((outlet) => {
            const option1 = document.createElement("option");
            option1.value = outlet;
            option1.textContent = outlet;
            outletSelect.appendChild(option1);

            const option2 = document.createElement("option");
            option2.value = outlet;
            option2.textContent = outlet;
            dataOutlet.appendChild(option2);
          });
        } catch (error) {
          console.error("Error loading outlets:", error);
        }
      }

      async function trainModel() {
        const btn = document.getElementById("trainBtn");
        const alertDiv = document.getElementById("trainingAlert");

        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Training...';
        alertDiv.innerHTML = "";

        try {
          const modelType = document.getElementById("modelType").value;
          const trainingPeriod =
            document.getElementById("trainingPeriod").value;

          const response = await fetch(API_URL + "/train", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model_type: modelType,
              training_period: trainingPeriod || null,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            alertDiv.innerHTML = `<div class="alert alert-success">
                        <strong>âœ“ Training Complete!</strong> Model: ${data.model_name}
                        <br>MAE: $${Math.round(data.metrics.mae).toLocaleString()}, 
                        RMSE: $${Math.round(data.metrics.rmse).toLocaleString()}, 
                        RÂ²: ${data.metrics.r2.toFixed(4)}
                    </div>`;
            loadModels();
          } else {
            alertDiv.innerHTML = `<div class="alert alert-error"><strong>Error:</strong> ${data.detail}</div>`;
          }
        } catch (error) {
          alertDiv.innerHTML = `<div class="alert alert-error"><strong>Error:</strong> ${error.message}</div>`;
        } finally {
          btn.disabled = false;
          btn.innerHTML = "Start Training";
        }
      }

      async function makePredictions() {
        const btn = document.getElementById("predictBtn");
        const alertDiv = document.getElementById("predictionsAlert");
        const resultsDiv = document.getElementById("predictionResults");

        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Generating...';
        alertDiv.innerHTML = "";
        resultsDiv.innerHTML =
          '<div class="spinner"><div class="loading"></div></div>';

        try {
          const modelName = document.getElementById("modelSelect").value;
          const outlet = document.getElementById("outletSelect").value;
          const startDate = document.getElementById("startDate").value;
          const endDate = document.getElementById("endDate").value;

          if (!modelName) {
            alertDiv.innerHTML =
              '<div class="alert alert-error">Please select a model</div>';
            return;
          }

          const params = new URLSearchParams({
            model_name: modelName,
            start_date: startDate,
            end_date: endDate,
          });
          if (outlet) params.append("outlet", outlet);

          const response = await fetch(API_URL + `/predict?${params}`, {
            method: "POST",
          });
          const data = await response.json();

          if (response.ok) {
            alertDiv.innerHTML = `<div class="alert alert-success">
                        âœ“ Generated ${data.predictions_count} predictions
                    </div>`;

            renderPredictionCharts(data);
          } else {
            alertDiv.innerHTML = `<div class="alert alert-error"><strong>Error:</strong> ${data.detail}</div>`;
          }
        } catch (error) {
          alertDiv.innerHTML = `<div class="alert alert-error"><strong>Error:</strong> ${error.message}</div>`;
        } finally {
          btn.disabled = false;
          btn.innerHTML = "Generate Predictions";
        }
      }

      function renderPredictionCharts(data) {
        const resultsDiv = document.getElementById("predictionResults");
        let html = `<div class="charts-grid">
                <div class="card">
                    <h3>Monthly Forecast Summary</h3>
                    <div class="chart-container">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Daily Predictions Trend</h3>
                    <div class="chart-container">
                        <canvas id="dailyTrendChart"></canvas>
                    </div>
                </div>
            </div>`;
        html += '<h3 style="margin-top: 20px;">Monthly Summary Table</h3>';
        html +=
          "<table><thead><tr><th>Outlet</th><th>Month</th><th>Predicted Sales</th></tr></thead><tbody>";

        data.monthly_summary.forEach((row) => {
          html += `<tr><td>${row.outlet}</td><td>${row.month}</td><td>$${Math.round(row.prediction).toLocaleString()}</td></tr>`;
        });
        html += "</tbody></table>";
        resultsDiv.innerHTML = html;

        setTimeout(() => {
          renderMonthlySalesChart(data.monthly_summary);
          renderDailyTrendChart(data.daily_predictions);
        }, 100);
      }

      function renderMonthlySalesChart(monthlySummary) {
        const ctx = document.getElementById("monthlySalesChart");
        if (!ctx) return;

        const outletData = {};
        monthlySummary.forEach((row) => {
          if (!outletData[row.outlet]) outletData[row.outlet] = [];
          outletData[row.outlet].push(parseFloat(row.prediction));
        });

        const outlets = Object.keys(outletData);
        const datasets = outlets.map((outlet, idx) => ({
          label: outlet.substring(0, 20),
          data: outletData[outlet],
          backgroundColor: `hsla(${(idx * 360) / outlets.length}, 70%, 60%, 0.7)`,
        }));

        if (monthlySalesChart) monthlySalesChart.destroy();

        monthlySalesChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Feb 2025"],
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "Sales ($)" },
              },
            },
          },
        });
      }

      function renderDailyTrendChart(dailyPredictions) {
        const ctx = document.getElementById("dailyTrendChart");
        if (!ctx) return;

        const dateData = {};
        dailyPredictions.forEach((pred) => {
          const date = pred.date.split("T")[0];
          if (!dateData[date]) dateData[date] = 0;
          dateData[date] += parseFloat(pred.prediction);
        });

        const dates = Object.keys(dateData).sort();
        const sales = dates.map((d) => dateData[d]);

        if (dailyTrendChart) dailyTrendChart.destroy();

        dailyTrendChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: dates,
            datasets: [
              {
                label: "Total Daily Predictions",
                data: sales,
                borderColor: "#667eea",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
            },
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
      }

      async function loadData() {
        const resultsDiv = document.getElementById("dataResults");
        resultsDiv.innerHTML =
          '<div class="spinner"><div class="loading"></div></div>';

        try {
          const outlet = document.getElementById("dataOutlet").value;
          const startDate = document.getElementById("dataStartDate").value;
          const endDate = document.getElementById("dataEndDate").value;

          const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
          });
          if (outlet) params.append("outlet", outlet);

          const response = await fetch(API_URL + `/data/daily?${params}`);
          const data = await response.json();

          let html = `<p><strong>${data.count} records found</strong></p><table><thead><tr><th>Date</th><th>Outlet</th><th>Sales</th></tr></thead><tbody>`;
          data.records.slice(0, 50).forEach((row) => {
            html += `<tr><td>${row.date}</td><td>${row.outlet}</td><td>$${Math.round(row.sales).toLocaleString()}</td></tr>`;
          });
          html += "</tbody></table>";
          resultsDiv.innerHTML = html;
        } catch (error) {
          resultsDiv.innerHTML = `<div class="alert alert-error">Error loading data: ${error.message}</div>`;
        }
      }

      function predictWithModel(modelName) {
        document.getElementById("modelSelect").value = modelName;
        switchTab("predictions");
      }

      function switchTab(tabName) {
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".tab-button")
          .forEach((el) => el.classList.remove("active"));

        document.getElementById(tabName + "-tab").classList.add("active");
        event.target.classList.add("active");
      }
    </script>
  </body>
</html>
